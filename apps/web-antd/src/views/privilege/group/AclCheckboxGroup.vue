<template>
  <div>
    <Spin :spinning="spinning">
      <Checkbox
        v-if="checkboxList && checkboxList.length > 0"
        :indeterminate="indeterminate"
        :checked="checkAll"
        @change="onCheckAllChange"
      >
        全选
      </Checkbox>
      <CheckboxGroup v-model:value="checkedList" :options="checkboxList" @change="onChange" />
    </Spin>
  </div>
</template>
<script lang="ts" setup>
  import { ref, defineProps, defineEmits, computed } from 'vue';
  import { Checkbox, Spin } from 'ant-design-vue';
  import { setAclByModule, setAclModuleList } from '#/api/privilege/acl';

  const CheckboxGroup = Checkbox.Group;

  const props = defineProps({
    checkboxList: {
      type: Array,
      default: []
    },
    groupId: {
      type: String,
      default: ''
    },
    moduleSn: {
      type: String,
      default: ''
    },
    moduleId: {
      type: String,
      default: ''
    },
  });

  const emit = defineEmits(['changeCheckAllStatus', '']);

  // 过滤所有选中项
  const defaultCheckeds = props.checkboxList.filter((item) => item.checked);
  const indeterminate = ref<boolean>(false);
  const checkAll = ref<boolean>(
    defaultCheckeds.length > 0 && props.checkboxList.length === defaultCheckeds.length,
  );

  if (defaultCheckeds.length !== 0 && props.checkboxList.length !== defaultCheckeds.length) {
    indeterminate.value = true;
  }

  const spinning = ref<boolean>(false);

  const checkedList = ref<any[]>(defaultCheckeds.map((item) => item.value));

  async function onChange(checkedListKeys) {
    spinning.value = true;
    indeterminate.value =
      !!checkedListKeys.length && checkedListKeys.length < props.checkboxList.length;
    checkAll.value = checkedListKeys.length === props.checkboxList.length;
    const params = {
      moduleId: props.moduleId,
      groupId: props.groupId,
      aclList: checkedListKeys,
    };
    try {
      await setAclModuleList(params);
      emit('changeCheckAllStatus');
    } finally {
      spinning.value = false;
    }
  }

  async function onCheckAllChange(e) {
    checkedList.value = e.target.checked ? props.checkboxList.map((item) => item.value) : [];
    indeterminate.value = false;
    checkAll.value = e.target.checked;

    spinning.value = true;

    // 批量保存数据
    await setAclByModule({
      checked: e.target.checked ? 1 : 0,
      aclInfo: {
        releaseId: props.groupId,
        moduleId: props.moduleId,
      },
    });
    emit('changeCheckAllStatus');
    spinning.value = false;
  }
</script>
